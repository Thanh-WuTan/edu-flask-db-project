{% extends 'admin/admin_panel.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container">
    <h1 style="color: #2C3E50;">Admin Dashboard</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 shadow" style="background-color: #FFFFFF; border: none;">
                <div class="card-body">
                    <h3 style="color: #2C3E50;">Manage Courses</h3>
                    <p style="color: #BDC3C7;">View, create, edit, or delete courses.</p>
                    <a href="{{ url_for('admin.courses') }}" class="btn" style="background-color: #2C3E50; color: #ECF0F1;">Courses Dashboard</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4 shadow" style="background-color: #FFFFFF; border: none;">
                <div class="card-body">
                    <h3 style="color: #2C3E50;">Manage Users</h3>
                    <p style="color: #BDC3C7;">View, create, edit, or delete users.</p>
                    <a href="{{ url_for('admin.users') }}" class="btn" style="background-color: #2C3E50; color: #ECF0F1;">Users Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mt-4">
        <!-- Courses by Department Pie Chart -->
        <div class="col-md-6 mb-4">
            <div class="card shadow" style="background-color: #FFFFFF; border: none;">
                <div class="card-body">
                    <h3 style="color: #2C3E50;">Courses by Department</h3>
                    <div class="chart-wrapper">
                        <canvas id="courseDeptChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- User Roles Pie Chart -->
        <div class="col-md-6 mb-4">
            <div class="card shadow" style="background-color: #FFFFFF; border: none;">
                <div class="card-body">
                    <h3 style="color: #2C3E50;">User Roles Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="userRolesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS for Chart Wrappers -->
<style>
    .chart-wrapper {
        width: 100%;
        height: 300px; /* Fixed height to prevent growing */
        max-width: 350px; /* Constrain width */
        margin: 0 auto; /* Center the chart */
        overflow: hidden; /* Prevent overflow from causing growth */
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 100% !important;
        max-height: 300px; /* Ensure canvas doesn't exceed wrapper */
    }

    /* Debugging: Add borders to visualize layout */
    .card {
        border: 1px solid #ccc !important;
    }
    .chart-wrapper {
        border: 1px dashed red; /* Temporary for debugging */
    }
</style>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // User Roles Pie Chart
    const userRolesCtx = document.getElementById('userRolesChart').getContext('2d');
    const userRolesChart = new Chart(userRolesCtx, {
        type: 'pie',
        data: {
            labels: {{ user_role_counts|map(attribute='role_name')|list|tojson }},
            datasets: [{
                data: {{ user_role_counts|map(attribute='user_count')|list|tojson }},
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Allow the chart to fit the container
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'User Roles Distribution' }
            }
        }
    });

    // Courses by Department Pie Chart
    const courseDeptCtx = document.getElementById('courseDeptChart').getContext('2d');
    const courseDeptChart = new Chart(courseDeptCtx, {
        type: 'pie',
        data: {
            labels: {{ course_dept_counts|map(attribute='department_name')|list|tojson }},
            datasets: [{
                data: {{ course_dept_counts|map(attribute='course_count')|list|tojson }},
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Allow the chart to fit the container
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Courses by Department' }
            }
        }
    });
</script>
{% endblock %}